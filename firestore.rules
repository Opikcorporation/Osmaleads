/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control (RBAC) model with owner-only and shared access patterns.
 *
 * Data Structure:
 * - /collaborators/{collaboratorId}: Stores collaborator profiles.
 * - /groups/{groupId}: Stores group information.
 * - /leads/{leadId}: Stores lead data, with 'assignedCollaboratorId' for access control.
 * - /leads/{leadId}/notes/{noteId}: Stores notes for leads, with denormalized 'assignedCollaboratorId'.
 *
 * Key Security Decisions:
 * - Collaborators can only access their own profile data.
 * - Admins can be configured via a separate `/roles_admin/{uid}` document (not implemented in this prototype but required for Group management).
 * - Leads are accessible to their assigned collaborator.
 * - Notes inherit access control from their parent lead, enforced via the denormalized `assignedCollaboratorId`.
 * - List operations are generally allowed for owners of user-scoped subcollections.
 *
 * Denormalization for Authorization:
 * - The `Note` entity denormalizes `assignedCollaboratorId` from the parent `Lead` document. This allows the security rules for notes to be independent of the lead document and avoids costly `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a collaborator to read and write their own profile.
     * @path /collaborators/{collaboratorId}
     * @allow (get, list, create, update, delete) if request.auth.uid == collaboratorId
     * @deny (get, list, create, update, delete) if request.auth.uid != collaboratorId
     * @principle Enforces document ownership for collaborator profiles.
     */
    match /collaborators/{collaboratorId} {
      allow get: if isSignedIn() && isOwner(collaboratorId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(collaboratorId) && request.resource.data.id == request.auth.uid;
      allow update: if isSignedIn() && isOwner(collaboratorId) && resource.data.id == request.resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(collaboratorId);
    }

    /**
     * @description Allows admins to manage groups. (Admin check is a placeholder)
     * @path /groups/{groupId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if false // TODO: Implement admin check once roles are defined.
     * @deny (create, update, delete) if true
     * @principle Restricts group management to admins.
     */
    match /groups/{groupId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin check once roles are defined.
    }

    /**
     * @description Allows the assigned collaborator to read/write leads.
     * @path /leads/{leadId}
     * @allow (get, list) if true
     * @allow (create) if request.auth.uid == request.resource.data.assignedCollaboratorId
     * @allow (update, delete) if resource.data.assignedCollaboratorId == request.auth.uid
     * @deny (create, update, delete) if resource.data.assignedCollaboratorId != request.auth.uid
     * @principle Enforces ownership via assignedCollaboratorId.
     */
    match /leads/{leadId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.assignedCollaboratorId == request.auth.uid;
      allow update: if isSignedIn() && isExistingAssignedCollaborator(resource.data.assignedCollaboratorId);
      allow delete: if isSignedIn() && isExistingAssignedCollaborator(resource.data.assignedCollaboratorId);

      /**
       * @description Allows the assigned collaborator to create/read/write notes for assigned leads.
       * @path /leads/{leadId}/notes/{noteId}
       * @allow (get, list) if resource.data.collaboratorId == request.auth.uid
       * @allow (create) if request.auth.uid == request.resource.data.collaboratorId
       * @allow (update, delete) if resource.data.collaboratorId == request.auth.uid
       * @deny (create, update, delete) if resource.data.collaboratorId != request.auth.uid
       * @principle Inherits ownership from the lead's assignedCollaboratorId and enforces it on notes.
       */
      match /notes/{noteId} {
        allow get, list: if isSignedIn() && resource.data.collaboratorId == request.auth.uid;
        allow create: if isSignedIn() && request.resource.data.collaboratorId == request.auth.uid && request.resource.data.leadId == leadId;
        allow update: if isSignedIn() && isExistingNoteCollaborator(resource.data.collaboratorId);
        allow delete: if isSignedIn() && isExistingNoteCollaborator(resource.data.collaboratorId);
      }
    }

    /**
     * @description Helper function to check if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Helper function to check if the user is the owner of the document based on the provided userId.
     * @param {string} userId The user ID to compare with the request's auth UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Helper function to check if the user is the owner of the existing document based on the provided userId.
     * @param {string} userId The user ID to compare with the request's auth UID.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Helper function to check if the user is the assigned collaborator of the lead based on the assignedCollaboratorId.
     * @param {string} assignedCollaboratorId The collaborator ID assigned to the lead.
     * @return {boolean} True if the user is the assigned collaborator, false otherwise.
     */
    function isAssignedCollaborator(assignedCollaboratorId) {
      return request.auth.uid == assignedCollaboratorId;
    }

    /**
     * @description Helper function to check if the user is the assigned collaborator of the EXISTING lead.
     * @param {string} assignedCollaboratorId The collaborator ID assigned to the lead.
     * @return {boolean} True if the user is the assigned collaborator, false otherwise.
     */
    function isExistingAssignedCollaborator(assignedCollaboratorId) {
        return isAssignedCollaborator(assignedCollaboratorId) && resource != null;
    }
    /**
     * @description Helper function to check if the user is the collaborator who created the note based on the collaboratorId.
     * @param {string} collaboratorId The collaborator ID who created the note.
     * @return {boolean} True if the user is the note creator, false otherwise.
     */
    function isNoteCollaborator(collaboratorId) {
      return request.auth.uid == collaboratorId;
    }

    /**
     * @description Helper function to check if the user is the collaborator of the EXISTING note.
     * @param {string} collaboratorId The collaborator ID who created the note.
     * @return {boolean} True if the user is the collaborator and the resource exists, false otherwise.
     */
    function isExistingNoteCollaborator(collaboratorId) {
        return isNoteCollaborator(collaboratorId) && resource != null;
    }
  }
}