/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control (RBAC) model with owner-only and shared access patterns.
 *
 * Data Structure:
 * - /collaborators/{collaboratorId}: Stores collaborator profiles.
 * - /groups/{groupId}: Stores group information.
 * - /leads/{leadId}: Stores lead data, with 'assignedCollaboratorId' for access control.
 * - /leads/{leadId}/notes/{noteId}: Stores notes for leads, with denormalized 'assignedCollaboratorId'.
 * - /distributionSettings/{settingId}: Stores lead distribution rules.
 *
 * Key Security Decisions:
 * - Collaborators can only access their own profile data.
 * - Admins can create new collaborator accounts.
 * - Leads are accessible to their assigned collaborator.
 * - Notes inherit access control from their parent lead, enforced via the denormalized `assignedCollaboratorId`.
 * - Distribution settings are only manageable by admins.
 *
 * Denormalization for Authorization:
 * - The `Note` entity denormalizes `assignedCollaboratorId` from the parent `Lead` document. This allows the security rules for notes to be independent of the lead document and avoids costly `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Helper function to check if the user has the 'admin' role.
     * It checks for the existence of a document in `/collaborators/{uid}` where the role is 'admin'.
     * @return {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/collaborators/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/collaborators/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * @description Allows a collaborator to read/write their own profile. Admins can read any profile and create new ones.
     * @path /collaborators/{collaboratorId}
     */
    match /collaborators/{collaboratorId} {
      // A user can list collaborators if they are signed in.
      allow list: if isSignedIn();
      // Any signed-in user can get a specific collaborator's document.
      allow get: if isSignedIn();
      // A new user can create their OWN profile document if it doesn't exist yet.
      allow create: if isSignedIn() && isOwner(collaboratorId) && !exists(/databases/$(database)/documents/collaborators/$(collaboratorId));
      // An existing user can only update their own profile.
      allow update: if isSignedIn() && isOwner(collaboratorId) && resource.data.id == request.resource.data.id;
      // Only an admin can delete a collaborator document.
      allow delete: if isAdmin();
    }
    
    /**
     * @description Allows admins to manage groups.
     * @path /groups/{groupId}
     */
    match /groups/{groupId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Allows admins to manage distribution settings.
     * @path /distributionSettings/{settingId}
     */
    match /distributionSettings/{settingId} {
        allow get, list, create, update, delete: if isSignedIn() && isAdmin();
    }


    /**
     * @description Allows the assigned collaborator to read/write leads.
     * @path /leads/{leadId}
     */
    match /leads/{leadId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.assignedCollaboratorId == request.auth.uid;
      allow update: if isSignedIn() && (isExistingAssignedCollaborator(resource.data.assignedCollaboratorId) || isAdmin());
      allow delete: if isSignedIn() && (isExistingAssignedCollaborator(resource.data.assignedCollaboratorId) || isAdmin());

      /**
       * @description Allows the assigned collaborator to create/read/write notes for assigned leads.
       * @path /leads/{leadId}/notes/{noteId}
       */
      match /notes/{noteId} {
        allow get, list: if isSignedIn() && (resource.data.collaboratorId == request.auth.uid || isAdmin());
        allow create: if isSignedIn() && request.resource.data.collaboratorId == request.auth.uid && request.resource.data.leadId == leadId;
        allow update: if isSignedIn() && (isExistingNoteCollaborator(resource.data.collaboratorId) || isAdmin());
        allow delete: if isSignedIn() && (isExistingNoteCollaborator(resource.data.collaboratorId) || isAdmin());
      }
    }

    /**
     * @description Helper function to check if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Helper function to check if the user is the owner of the document based on the provided userId.
     * @param {string} userId The user ID to compare with the request's auth UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Helper function to check if the user is the owner of the existing document based on the provided userId.
     * @param {string} userId The user ID to compare with the request's auth UID.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Helper function to check if the user is the assigned collaborator of the lead based on the assignedCollaboratorId.
     * @param {string} assignedCollaboratorId The collaborator ID assigned to the lead.
     * @return {boolean} True if the user is the assigned collaborator, false otherwise.
     */
    function isAssignedCollaborator(assignedCollaboratorId) {
      return request.auth.uid == assignedCollaboratorId;
    }

    /**
     * @description Helper function to check if the user is the assigned collaborator of the EXISTING lead.
     * @param {string} assignedCollaboratorId The collaborator ID assigned to the lead.
     * @return {boolean} True if the user is the assigned collaborator, false otherwise.
     */
    function isExistingAssignedCollaborator(assignedCollaboratorId) {
        return isAssignedCollaborator(assignedCollaboratorId) && resource != null;
    }
    /**
     * @description Helper function to check if the user is the collaborator who created the note based on the collaboratorId.
     * @param {string} collaboratorId The collaborator ID who created the note.
     * @return {boolean} True if the user is the note creator, false otherwise.
     */
    function isNoteCollaborator(collaboratorId) {
      return request.auth.uid == collaboratorId;
    }

    /**
     * @description Helper function to check if the user is the collaborator of the EXISTING note.
     * @param {string} collaboratorId The collaborator ID who created the note.
     * @return {boolean} True if the user is the collaborator and the resource exists, false otherwise.
     */
    function isExistingNoteCollaborator(collaboratorId) {
        return isNoteCollaborator(collaboratorId) && resource != null;
    }
  }
}
